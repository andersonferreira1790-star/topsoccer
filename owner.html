<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Painel Propriet√°rio | Top Soccer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root { --arena: #FF4500; --bg: #050505; --card: #0e0e0e; --card-hover: #131313; --success: #39FF14; --danger: #ff5555; --warn: #FFD700; --info: #00BFFF; --border: rgba(255,255,255,0.04); --text: rgba(255,255,255,0.85); --muted: rgba(255,255,255,0.35); --subtle: rgba(255,255,255,0.08); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding-bottom: 80px; }
        .font-impact { font-family: 'Archivo Black', sans-serif; text-transform: uppercase; font-style: italic; }

        /* TOAST */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 18px; border-radius: 10px; color: white; font-size: 12px; font-weight: 600; box-shadow: 0 8px 30px rgba(0,0,0,0.4); animation: toastIn 0.3s ease, toastOut 0.3s ease forwards; animation-delay: 0s, 3s; max-width: 320px; backdrop-filter: blur(10px); letter-spacing: 0.3px; }
        .toast-success { background: rgba(57,255,20,0.12); border: 1px solid rgba(57,255,20,0.25); }
        .toast-error { background: rgba(255,0,64,0.12); border: 1px solid rgba(255,0,64,0.25); }
        .toast-info { background: rgba(255,69,0,0.12); border: 1px solid rgba(255,69,0,0.25); }
        @keyframes toastIn { from { opacity: 0; transform: translateX(80px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-15px); } }

        /* HEADER */
        .header { position: fixed; top: 0; width: 100%; height: 60px; z-index: 50; background: rgba(8,8,8,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .header-brand { font-size: 14px; letter-spacing: 3px; }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .header-btn { font-size: 10px; font-weight: 600; padding: 6px 14px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px; text-transform: uppercase; text-decoration: none; }
        .header-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.12); }
        .header-btn.accent { border-color: rgba(255,69,0,0.2); color: rgba(255,69,0,0.7); }
        .header-btn.accent:hover { border-color: rgba(255,69,0,0.4); color: var(--arena); }

        /* CONTENT */
        .content { max-width: 900px; margin: 0 auto; padding: 76px 16px 20px; }

        /* STATS ROW */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 24px; }
        @media (max-width: 640px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
        .stat { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; position: relative; overflow: hidden; }
        .stat::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; }
        .stat.s-orange::after { background: linear-gradient(90deg, var(--arena), transparent); }
        .stat.s-green::after { background: linear-gradient(90deg, var(--success), transparent); }
        .stat.s-yellow::after { background: linear-gradient(90deg, var(--warn), transparent); }
        .stat.s-blue::after { background: linear-gradient(90deg, var(--info), transparent); }
        .stat-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); font-weight: 600; }
        .stat-value { font-size: 22px; font-weight: 800; margin-top: 6px; }
        .stat-value.v-orange { color: var(--arena); }
        .stat-value.v-green { color: var(--success); }
        .stat-value.v-yellow { color: var(--warn); }
        .stat-value.v-blue { color: var(--info); }

        /* SECTION */
        .section { margin-bottom: 28px; }
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 2px; }
        .section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); }
        .section-badge { font-size: 9px; font-weight: 700; padding: 3px 10px; border-radius: 6px; background: var(--subtle); color: var(--muted); letter-spacing: 0.5px; }

        /* FILTERS */
        .filters-bar { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; margin-bottom: 20px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .filter-input { background: #141414; border: 1px solid var(--border); color: var(--text); padding: 7px 12px; border-radius: 8px; font-size: 11px; font-weight: 500; outline: none; transition: border-color 0.2s; }
        .filter-input:focus { border-color: rgba(255,69,0,0.3); }
        .filter-input option { background: #1a1a1a; color: #e0e0e0; padding: 8px; font-size: 12px; }
        select.filter-input { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M3 4.5L6 7.5L9 4.5'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; cursor: pointer; }
        .filter-btn { font-size: 10px; font-weight: 600; padding: 7px 14px; border-radius: 8px; border: 1px solid rgba(255,69,0,0.15); background: rgba(255,69,0,0.06); color: rgba(255,69,0,0.7); cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px; text-transform: uppercase; }
        .filter-btn:hover { background: rgba(255,69,0,0.12); color: var(--arena); }
        .filter-btn.ghost { background: transparent; border-color: var(--border); color: var(--muted); }
        .filter-btn.ghost:hover { color: var(--text); border-color: rgba(255,255,255,0.1); }

        /* TAB NAV */
        .tab-nav { display: flex; gap: 4px; margin-bottom: 20px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 4px; }
        .tab-item { flex: 1; text-align: center; padding: 8px 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .tab-item.active { background: rgba(255,69,0,0.1); color: var(--arena); }
        .tab-item:hover:not(.active) { color: var(--text); }
        .tab-count { font-size: 9px; opacity: 0.5; margin-left: 3px; }

        /* DATE GROUP */
        .date-group { margin-bottom: 24px; }
        .date-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); margin-bottom: 10px; padding-left: 2px; display: flex; align-items: center; gap: 8px; }
        .date-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .date-dot.today { background: var(--success); box-shadow: 0 0 8px rgba(57,255,20,0.4); }
        .date-dot.tomorrow { background: var(--info); }
        .date-dot.future { background: var(--arena); }
        .date-dot.past { background: rgba(255,255,255,0.15); }

        /* EVENT CARD */
        .event-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; margin-bottom: 10px; overflow: hidden; transition: border-color 0.2s; }
        .event-card:hover { border-color: rgba(255,255,255,0.08); }
        .event-card.cancelado { opacity: 0.5; }
        .event-head { padding: 16px 18px; cursor: pointer; display: flex; align-items: center; gap: 14px; }
        .event-head:hover { background: var(--card-hover); }
        .event-avatar { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; flex-shrink: 0; }
        .event-avatar.racha { background: rgba(255,69,0,0.08); border: 1px solid rgba(255,69,0,0.15); color: var(--arena); }
        .event-avatar.individual { background: rgba(0,191,255,0.08); border: 1px solid rgba(0,191,255,0.15); color: var(--info); }
        .event-info { flex: 1; min-width: 0; }
        .event-admin { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--arena); margin-bottom: 2px; }
        .event-details { font-size: 12px; color: var(--muted); font-weight: 500; }
        .event-details span { color: var(--text); font-weight: 600; }
        .event-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
        .event-value { font-size: 14px; font-weight: 800; }
        .event-value.paid { color: var(--success); }
        .event-value.partial { color: var(--warn); }
        .event-value.unpaid { color: var(--danger); }
        .event-status { font-size: 8px; font-weight: 700; padding: 2px 8px; border-radius: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .event-status.confirmado { background: rgba(57,255,20,0.08); color: rgba(57,255,20,0.6); border: 1px solid rgba(57,255,20,0.15); }
        .event-status.interesse { background: rgba(255,165,0,0.08); color: rgba(255,165,0,0.6); border: 1px solid rgba(255,165,0,0.15); }
        .event-status.cancelado { background: rgba(255,85,85,0.08); color: rgba(255,85,85,0.5); border: 1px solid rgba(255,85,85,0.12); }
        .event-status.concluido { background: rgba(0,191,255,0.08); color: rgba(0,191,255,0.5); border: 1px solid rgba(0,191,255,0.12); }
        .event-chevron { color: var(--muted); font-size: 10px; transition: transform 0.25s; margin-left: 6px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
        .event-chevron.open { transform: rotate(180deg); }

        /* PROGRESS BAR */
        .progress-wrap { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .progress-bar { flex: 1; height: 3px; background: var(--subtle); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.4s ease; }
        .progress-fill.green { background: var(--success); }
        .progress-fill.orange { background: orange; }
        .progress-text { font-size: 9px; color: var(--muted); font-weight: 600; white-space: nowrap; }

        /* EVENT BODY (expandable) */
        .event-body { display: none; border-top: 1px solid var(--border); padding: 16px 18px; }
        .event-body.open { display: block; animation: fadeSlide 0.25s ease; }
        @keyframes fadeSlide { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }

        /* EVENT META */
        .event-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 16px; }
        .meta-item { background: var(--subtle); border-radius: 10px; padding: 10px 12px; }
        .meta-label { font-size: 8px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); font-weight: 700; }
        .meta-value { font-size: 13px; font-weight: 700; margin-top: 3px; color: var(--text); }

        /* PARTICIPANT ROW */
        .p-list { margin-top: 12px; }
        .p-list-header { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 8px; }
        .p-row { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: rgba(255,255,255,0.015); border-radius: 10px; margin-bottom: 6px; border-left: 2px solid; transition: background 0.2s; }
        .p-row:hover { background: rgba(255,255,255,0.03); }
        .p-row.pago { border-left-color: rgba(57,255,20,0.35); }
        .p-row.pendente { border-left-color: rgba(255,165,0,0.4); }
        .p-name { font-size: 12px; font-weight: 600; color: var(--text); }
        .p-contact { font-size: 9px; color: var(--muted); margin-top: 1px; }
        .p-badge { font-size: 8px; font-weight: 700; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .p-badge.pago { background: rgba(57,255,20,0.06); color: rgba(57,255,20,0.6); border: 1px solid rgba(57,255,20,0.15); }
        .p-badge.pendente { background: rgba(255,165,0,0.06); color: rgba(255,165,0,0.6); border: 1px solid rgba(255,165,0,0.15); }
        .p-actions { display: flex; gap: 4px; }
        .p-action-btn { width: 24px; height: 24px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .p-action-btn:hover { border-color: rgba(255,255,255,0.12); color: var(--text); }
        .p-action-btn.toggle-pay:hover { border-color: rgba(57,255,20,0.3); color: var(--success); }
        .p-action-btn.delete:hover { border-color: rgba(255,85,85,0.3); color: var(--danger); }

        /* EVENT ACTIONS */
        .event-actions { display: flex; gap: 6px; margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); flex-wrap: wrap; }
        .ev-btn { font-size: 10px; font-weight: 600; padding: 7px 14px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px; }
        .ev-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.1); background: var(--subtle); }
        .ev-btn.danger { border-color: rgba(255,85,85,0.15); color: rgba(255,85,85,0.5); }
        .ev-btn.danger:hover { border-color: rgba(255,85,85,0.3); color: var(--danger); background: rgba(255,85,85,0.06); }
        .ev-btn.success { border-color: rgba(57,255,20,0.15); color: rgba(57,255,20,0.5); }
        .ev-btn.success:hover { border-color: rgba(57,255,20,0.3); color: var(--success); background: rgba(57,255,20,0.06); }

        /* CONFIRM MODAL */
        .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
        .confirm-overlay.active { display: flex; animation: fadeIn 0.15s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .confirm-box { background: linear-gradient(145deg, #161616, #0c0c0c); border: 1px solid rgba(255,255,255,0.06); border-radius: 20px; padding: 28px; max-width: 380px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: slideUp 0.25s cubic-bezier(0.16,1,0.3,1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .confirm-icon { width: 48px; height: 48px; margin: 0 auto 14px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .confirm-title { font-size: 15px; font-weight: 700; text-align: center; margin-bottom: 6px; letter-spacing: 1px; text-transform: uppercase; }
        .confirm-text { color: var(--muted); text-align: center; font-size: 12px; margin-bottom: 18px; line-height: 1.5; }
        .confirm-btns { display: flex; gap: 8px; }
        .confirm-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.2s; }
        .confirm-btn.primary { background: rgba(255,69,0,0.12); color: var(--arena); border: 1px solid rgba(255,69,0,0.25); }
        .confirm-btn.primary:hover { background: rgba(255,69,0,0.2); }
        .confirm-btn.danger-btn { background: rgba(255,85,85,0.1); color: #ff6b6b; border: 1px solid rgba(255,85,85,0.2); }
        .confirm-btn.danger-btn:hover { background: rgba(255,85,85,0.18); }
        .confirm-btn.ghost-btn { background: rgba(255,255,255,0.03); color: var(--muted); border: 1px solid var(--border); }
        .confirm-btn.ghost-btn:hover { color: var(--text); }

        /* EMPTY */
        .empty-state { text-align: center; padding: 50px 20px; }
        .empty-icon { font-size: 36px; opacity: 0.15; margin-bottom: 14px; }
        .empty-text { font-size: 12px; color: var(--muted); }

        /* LOADING */
        .loading-wrap { text-align: center; padding: 60px; }
        .spinner { width: 32px; height: 32px; border: 2px solid var(--subtle); border-top-color: var(--arena); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }

        /* PENDENCIAS ALERT */
        .alert-banner { background: var(--card); border: 1px solid rgba(255,85,85,0.12); border-radius: 14px; padding: 14px 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
        .alert-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); flex-shrink: 0; animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .alert-text { font-size: 11px; color: var(--muted); font-weight: 500; }
        .alert-text strong { color: var(--danger); font-weight: 700; }

        /* SCHEDULE MODAL */
        .schedule-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); backdrop-filter: blur(10px); z-index: 150; display: none; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; }
        .schedule-overlay.active { display: flex; animation: fadeIn 0.15s; }
        .schedule-box { background: linear-gradient(145deg, #161616, #0c0c0c); border: 1px solid rgba(255,255,255,0.06); border-radius: 22px; padding: 28px; max-width: 460px; width: 100%; margin-top: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1); }
        .schedule-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 22px; }
        .schedule-title { font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; color: var(--arena); }
        .schedule-close { width: 30px; height: 30px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .schedule-close:hover { color: var(--text); border-color: rgba(255,255,255,0.12); }
        .form-group { margin-bottom: 16px; }
        .form-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 6px; display: block; }
        .form-input { width: 100%; background: #141414; border: 1px solid var(--border); color: var(--text); padding: 10px 14px; border-radius: 10px; font-size: 12px; font-weight: 500; outline: none; transition: border-color 0.2s; font-family: 'Inter', sans-serif; }
        .form-input:focus { border-color: rgba(255,69,0,0.35); }
        .form-input::placeholder { color: var(--muted); }
        .form-input option { background: #1a1a1a; color: #e0e0e0; padding: 8px 12px; font-size: 13px; }
        .form-input option:checked { background: #2a2a2a; }
        select.form-input { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M3 4.5L6 7.5L9 4.5'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; cursor: pointer; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .quadra-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        @media (max-width: 420px) { .quadra-grid { grid-template-columns: repeat(2, 1fr); } }
        .quadra-opt { padding: 10px 8px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.02); color: var(--muted); text-align: center; cursor: pointer; transition: all 0.2s; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .quadra-opt:hover { border-color: rgba(255,255,255,0.1); color: var(--text); }
        .quadra-opt.selected { border-color: rgba(255,69,0,0.35); background: rgba(255,69,0,0.08); color: var(--arena); }
        .quadra-price { font-size: 8px; color: var(--muted); margin-top: 2px; display: block; }
        .quadra-opt.selected .quadra-price { color: rgba(255,69,0,0.5); }
        .mode-toggle { display: flex; gap: 6px; }
        .mode-btn { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.02); color: var(--muted); text-align: center; cursor: pointer; transition: all 0.2s; font-size: 11px; font-weight: 600; }
        .mode-btn:hover { border-color: rgba(255,255,255,0.1); color: var(--text); }
        .mode-btn.selected { border-color: rgba(255,69,0,0.35); background: rgba(255,69,0,0.08); color: var(--arena); }
        .racha-config { display: none; margin-top: 12px; padding: 14px; background: var(--subtle); border-radius: 12px; }
        .racha-config.show { display: block; animation: fadeSlide 0.2s ease; }
        .racha-row { display: flex; align-items: center; justify-content: space-between; }
        .racha-stepper { display: flex; align-items: center; gap: 12px; }
        .stepper-btn { width: 30px; height: 30px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .stepper-btn:hover { border-color: rgba(255,69,0,0.3); color: var(--arena); }
        .stepper-value { font-size: 18px; font-weight: 800; color: var(--arena); min-width: 30px; text-align: center; }
        .form-summary { background: var(--subtle); border-radius: 14px; padding: 16px; margin-top: 8px; margin-bottom: 16px; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .summary-label { font-size: 10px; color: var(--muted); font-weight: 600; }
        .summary-value { font-size: 12px; font-weight: 700; color: var(--text); }
        .summary-value.highlight { color: var(--success); font-size: 16px; }
        .form-submit { width: 100%; padding: 14px; border-radius: 12px; border: none; background: rgba(255,69,0,0.12); color: var(--arena); font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 1.5px; cursor: pointer; transition: all 0.2s; border: 1px solid rgba(255,69,0,0.25); }
        .form-submit:hover { background: rgba(255,69,0,0.2); }
        .form-submit:disabled { opacity: 0.4; cursor: not-allowed; }
        .new-booking-btn { font-size: 10px; font-weight: 700; padding: 6px 14px; border-radius: 8px; border: 1px solid rgba(255,69,0,0.3); background: rgba(255,69,0,0.08); color: var(--arena); cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px; text-transform: uppercase; }
        .new-booking-btn:hover { background: rgba(255,69,0,0.15); border-color: rgba(255,69,0,0.5); }

        /* LINK RESULT MODAL */
        .link-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); backdrop-filter: blur(10px); z-index: 250; display: none; align-items: center; justify-content: center; padding: 20px; }
        .link-overlay.active { display: flex; animation: fadeIn 0.15s; }
        .link-box { background: linear-gradient(145deg, #161616, #0c0c0c); border: 1px solid rgba(57,255,20,0.12); border-radius: 22px; padding: 30px; max-width: 420px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(57,255,20,0.04); animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1); text-align: center; }
        .link-success-icon { width: 56px; height: 56px; margin: 0 auto 16px; border-radius: 16px; background: rgba(57,255,20,0.08); border: 1px solid rgba(57,255,20,0.2); display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .link-title { font-size: 16px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; color: var(--success); margin-bottom: 4px; }
        .link-subtitle { font-size: 11px; color: var(--muted); margin-bottom: 20px; }
        .link-url-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; word-break: break-all; font-size: 11px; color: var(--text); font-weight: 500; text-align: left; line-height: 1.6; user-select: all; }
        .link-actions { display: flex; flex-direction: column; gap: 8px; }
        .link-action-btn { width: 100%; padding: 13px; border-radius: 12px; border: none; font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .link-action-btn.whatsapp { background: rgba(37,211,102,0.12); color: #25D366; border: 1px solid rgba(37,211,102,0.25); }
        .link-action-btn.whatsapp:hover { background: rgba(37,211,102,0.2); }
        .link-action-btn.copy { background: rgba(255,69,0,0.1); color: var(--arena); border: 1px solid rgba(255,69,0,0.25); }
        .link-action-btn.copy:hover { background: rgba(255,69,0,0.18); }
        .link-action-btn.close-link { background: rgba(255,255,255,0.03); color: var(--muted); border: 1px solid var(--border); }
        .link-action-btn.close-link:hover { color: var(--text); }
        .link-info { font-size: 10px; color: var(--muted); margin-top: 14px; line-height: 1.5; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="header">
        <div class="font-impact header-brand">
            TOP <span style="color: var(--arena);">OWNER</span>
        </div>
        <div class="header-actions">
            <span style="font-size: 9px; color: var(--muted); font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;" id="ownerName">---</span>
            <button onclick="abrirAgendamento()" class="new-booking-btn">+ Agendar</button>
            <a href="admin.html" class="header-btn">Admin</a>
            <button onclick="logout()" class="header-btn accent">Sair</button>
        </div>
    </header>

    <div class="content">
        <!-- LOADING -->
        <div id="loadingState" class="loading-wrap">
            <div class="spinner"></div>
            <p style="margin-top: 16px; font-size: 11px; color: var(--muted);">Carregando dados...</p>
        </div>

        <!-- MAIN CONTENT -->
        <div id="mainContent" style="display: none;">

            <!-- STATS -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">Resumo Geral</div>
                    <div class="section-badge" id="dataHoje">--</div>
                </div>
                <div class="stats-row">
                    <div class="stat s-orange">
                        <div class="stat-label">Eventos</div>
                        <div class="stat-value v-orange" id="totalEventos">0</div>
                    </div>
                    <div class="stat s-green">
                        <div class="stat-label">Receita</div>
                        <div class="stat-value v-green" id="totalReceita">R$ 0</div>
                    </div>
                    <div class="stat s-yellow">
                        <div class="stat-label">Pendente</div>
                        <div class="stat-value v-yellow" id="totalPendente">R$ 0</div>
                    </div>
                    <div class="stat s-blue">
                        <div class="stat-label">Jogadores</div>
                        <div class="stat-value v-blue" id="totalJogadores">0</div>
                    </div>
                </div>
            </div>

            <!-- ALERT PENDENCIAS -->
            <div id="alertPendencias" style="display: none;">
                <div class="alert-banner">
                    <div class="alert-dot"></div>
                    <div class="alert-text" id="alertText">--</div>
                </div>
            </div>

            <!-- TABS -->
            <div class="tab-nav">
                <div class="tab-item active" data-tab="ativos" onclick="switchTab('ativos')">Ativos <span class="tab-count" id="countAtivos">0</span></div>
                <div class="tab-item" data-tab="hoje" onclick="switchTab('hoje')">Hoje <span class="tab-count" id="countHoje">0</span></div>
                <div class="tab-item" data-tab="passados" onclick="switchTab('passados')">Passados <span class="tab-count" id="countPassados">0</span></div>
                <div class="tab-item" data-tab="todos" onclick="switchTab('todos')">Todos</div>
            </div>

            <!-- FILTERS -->
            <div class="filters-bar">
                <input type="date" class="filter-input" id="filtroDataInicio">
                <input type="date" class="filter-input" id="filtroDataFim">
                <select class="filter-input" id="filtroQuadra">
                    <option value="">Todas quadras</option>
                    <option value="Quadra 1">Quadra 1</option>
                    <option value="Quadra 2">Quadra 2</option>
                    <option value="Quadra 3">Quadra 3</option>
                    <option value="Campo Oficial">Campo Oficial</option>
                    <option value="Mini Campo">Mini Campo</option>
                </select>
                <select class="filter-input" id="filtroAdmin">
                    <option value="">Todos admins</option>
                </select>
                <button class="filter-btn" onclick="aplicarFiltros()">Filtrar</button>
                <button class="filter-btn ghost" onclick="limparFiltros()">Limpar</button>
            </div>

            <!-- EVENTS -->
            <div id="eventsContainer"></div>

            <!-- EMPTY -->
            <div id="emptyState" style="display: none;">
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <div class="empty-text">Nenhum evento encontrado</div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCHEDULE MODAL -->
    <div id="scheduleModal" class="schedule-overlay">
        <div class="schedule-box">
            <div class="schedule-header">
                <div class="schedule-title">Novo Agendamento</div>
                <button class="schedule-close" onclick="fecharAgendamento()">‚úï</button>
            </div>

            <!-- Para quem -->
            <div class="form-group">
                <label class="form-label">Para quem</label>
                <input type="text" class="form-input" id="schedNome" placeholder="Nome da pessoa (ex: Jo√£o Silva)" autocomplete="off">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="tel" class="form-input" id="schedTelefone" placeholder="(11) 99999-9999">
                </div>
                <div class="form-group">
                    <label class="form-label">Email (opcional)</label>
                    <input type="email" class="form-input" id="schedEmail" placeholder="email@exemplo.com">
                </div>
            </div>

            <!-- Quadra -->
            <div class="form-group">
                <label class="form-label">Quadra</label>
                <div class="quadra-grid">
                    <div class="quadra-opt" onclick="setSchedQuadra('Quadra 1', this)">Quadra 1<span class="quadra-price">R$ 75/h</span></div>
                    <div class="quadra-opt" onclick="setSchedQuadra('Quadra 2', this)">Quadra 2<span class="quadra-price">R$ 85/h</span></div>
                    <div class="quadra-opt" onclick="setSchedQuadra('Quadra 3', this)">Quadra 3<span class="quadra-price">R$ 85/h</span></div>
                    <div class="quadra-opt" onclick="setSchedQuadra('Campo Oficial', this)">Campo Oficial<span class="quadra-price">R$ 190/h</span></div>
                    <div class="quadra-opt" onclick="setSchedQuadra('Mini Campo', this)">Mini Campo<span class="quadra-price">R$ 75/h</span></div>
                </div>
            </div>

            <!-- Data e Hor√°rio -->
            <div class="form-row-3">
                <div class="form-group">
                    <label class="form-label">Data</label>
                    <input type="date" class="form-input" id="schedData">
                </div>
                <div class="form-group">
                    <label class="form-label">Hora Inicio</label>
                    <select class="form-input" id="schedHoraInicio"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Hora Fim</label>
                    <select class="form-input" id="schedHoraFim"></select>
                </div>
            </div>

            <!-- Modo -->
            <div class="form-group">
                <label class="form-label">Tipo de Reserva</label>
                <div class="mode-toggle">
                    <div class="mode-btn selected" id="modeIndividual" onclick="setSchedModo('individual')">Individual</div>
                    <div class="mode-btn" id="modeRacha" onclick="setSchedModo('racha')">Racha</div>
                </div>
            </div>

            <!-- Racha Config -->
            <div class="racha-config" id="rachaConfig">
                <div class="racha-row">
                    <div>
                        <div class="form-label" style="margin-bottom:2px;">Jogadores</div>
                        <div style="font-size:10px; color: var(--muted);">Valor dividido entre eles</div>
                    </div>
                    <div class="racha-stepper">
                        <button class="stepper-btn" onclick="mudarSchedJogadores(-1)">-</button>
                        <span class="stepper-value" id="schedJogadoresNum">10</span>
                        <button class="stepper-btn" onclick="mudarSchedJogadores(1)">+</button>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="form-group" style="margin-top: 12px;">
                <label class="form-label">Status Inicial</label>
                <select class="form-input" id="schedStatus">
                    <option value="confirmado">Confirmado</option>
                    <option value="interesse">Interesse (pendente)</option>
                </select>
            </div>

            <!-- Pagamento -->
            <div class="form-group">
                <label class="form-label">Marcar como pago?</label>
                <div class="mode-toggle">
                    <div class="mode-btn" id="payNao" onclick="setSchedPago(false)">N√£o ‚Äî Pendente</div>
                    <div class="mode-btn" id="paySim" onclick="setSchedPago(true)">‚úì Sim ‚Äî J√° Pagou</div>
                </div>
            </div>

            <!-- Summary -->
            <div class="form-summary" id="schedSummary">
                <div class="summary-row">
                    <span class="summary-label">Quadra</span>
                    <span class="summary-value" id="sumQuadra">‚Äî</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Hor√°rio</span>
                    <span class="summary-value" id="sumHorario">‚Äî</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Valor Total</span>
                    <span class="summary-value highlight" id="sumTotal">‚Äî</span>
                </div>
                <div class="summary-row" id="sumPessoaRow" style="display:none;">
                    <span class="summary-label">Valor / Pessoa</span>
                    <span class="summary-value" id="sumPessoa">‚Äî</span>
                </div>
            </div>

            <button class="form-submit" id="btnCriarAgendamento" onclick="criarNovoAgendamento()">
                Criar Agendamento
            </button>
        </div>
    </div>

    <!-- MODAL REGRAS DE RESERVA (aparece antes dos links no modo individual) -->
    <div id="regrasReservaModal" class="link-overlay">
        <div class="link-box" style="padding: 0; overflow: hidden; max-width: 440px;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, rgba(255,69,0,0.15), rgba(255,200,0,0.08)); padding: 24px 24px 16px; border-bottom: 1px solid rgba(255,69,0,0.2); text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">üìã</div>
                <h2 style="color: var(--arena); font-size: 16px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; margin: 0;">Regras de Reserva</h2>
                <p style="color: #888; font-size: 11px; margin-top: 6px;">Modo Individual ‚Äî Leia antes de compartilhar os links</p>
            </div>
            <!-- Regra 1: 30% -->
            <div style="padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.04);">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="min-width: 36px; height: 36px; border-radius: 10px; background: rgba(57,255,20,0.1); border: 1px solid rgba(57,255,20,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">‚ö°</div>
                    <div>
                        <div style="color: #39FF14; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">Link de Pagamento (30% Entrada)</div>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; list-style: none;">
                            <li style="color: #ccc; font-size: 11px; line-height: 1.7;">‚úÖ Garante a reserva <strong style="color: #39FF14;">IMEDIATA</strong> da quadra</li>
                            <li style="color: #ccc; font-size: 11px; line-height: 1.7;">‚úÖ O hor√°rio fica <strong style="color: #39FF14;">bloqueado</strong> na hora do pagamento</li>
                            <li style="color: #ccc; font-size: 11px; line-height: 1.7;">‚úÖ Ningu√©m mais pode reservar esse hor√°rio</li>
                            <li style="color: #ccc; font-size: 11px; line-height: 1.7;">‚úÖ Ap√≥s pagar 30%, √© gerado link para os 70% restantes</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Regra 2: Valor Total -->
            <div style="padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.04);">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="min-width: 36px; height: 36px; border-radius: 10px; background: rgba(255,200,0,0.1); border: 1px solid rgba(255,200,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">‚ö†Ô∏è</div>
                    <div>
                        <div style="color: #FFC800; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">Link de Convite (Sem Pagamento)</div>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; list-style: none;">
                            <li style="color: #ccc; font-size: 11px; line-height: 1.7;">‚ùå <strong style="color: #FFC800;">N√ÉO</strong> garante a reserva de imediato</li>
                            <li style="color: #ccc; font-size: 11px; line-height: 1.7;">‚ùå O status fica <strong style="color: #FFC800;">AMARELO</strong> (interesse)</li>
                            <li style="color: #ccc; font-size: 11px; line-height: 1.7;">‚ùå Outro usu√°rio pode pagar primeiro e reservar o hor√°rio</li>
                            <li style="color: #ccc; font-size: 11px; line-height: 1.7;">‚ùå Serve para confirmar presen√ßa dos demais jogadores</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Resumo -->
            <div style="padding: 16px 20px; background: rgba(255,69,0,0.05);">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="min-width: 36px; height: 36px; border-radius: 10px; background: rgba(255,69,0,0.1); border: 1px solid rgba(255,69,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">üèÜ</div>
                    <div>
                        <div style="color: var(--arena); font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">Resumo</div>
                        <p style="color: #aaa; font-size: 11px; line-height: 1.7; margin: 6px 0 0;">A reserva <strong style="color: white;">IMEDIATA</strong> do hor√°rio s√≥ acontece via pagamento dos <strong style="color: #39FF14;">30% (entrada)</strong>. Sem esse pagamento, o agendamento fica como <strong style="color: #FFC800;">"interesse"</strong> e o hor√°rio permanece dispon√≠vel para outros usu√°rios.</p>
                    </div>
                </div>
            </div>
            <!-- Bot√£o -->
            <div style="padding: 16px 20px;">
                <button onclick="fecharRegrasEMostrarLinks()" style="width: 100%; background: linear-gradient(135deg, var(--arena), #FF6B00); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 13px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,69,0,0.3);">‚úÖ ENTENDI ‚Äî VER MEUS LINKS</button>
            </div>
        </div>
    </div>

    <!-- LINK RESULT MODAL -->
    <div id="linkResultModal" class="link-overlay">
        <div class="link-box">
            <div class="link-success-icon">‚úì</div>
            <div class="link-title">Agendamento Criado!</div>
            <div class="link-subtitle" id="linkResultSubtitle">Envie os links abaixo</div>

            <!-- LINK PAGAMENTO (s√≥ aparece no modo individual) -->
            <div id="linkPagamentoArea" style="display: none; margin-bottom: 15px;">
                <div style="font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--arena); letter-spacing: 1px; margin-bottom: 6px;">üí≥ Link de Pagamento (enviar para quem vai pagar)</div>
                <div class="link-url-box" id="linkPagamentoUrl" style="border-color: var(--arena); color: var(--arena);">---</div>
                <div class="link-actions" style="margin-top: 8px;">
                    <button class="link-action-btn whatsapp" onclick="enviarWhatsApp('pagamento')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        WhatsApp Pagamento
                    </button>
                    <button class="link-action-btn copy" onclick="copiarLinkEspecifico('linkPagamentoUrl')">
                        üìã Copiar
                    </button>
                </div>
            </div>

            <!-- LINK CONVITE (sempre aparece) -->
            <div id="linkConviteArea" style="margin-bottom: 15px;">
                <div id="linkConviteLabel" style="font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--success); letter-spacing: 1px; margin-bottom: 6px;">üë• Link de Convite (confirma√ß√£o de presen√ßa)</div>
                <div class="link-url-box" id="linkResultUrl" style="border-color: var(--success); color: var(--success);">---</div>
                <div class="link-actions" style="margin-top: 8px;">
                    <button class="link-action-btn whatsapp" onclick="enviarWhatsApp('convite')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        WhatsApp Convite
                    </button>
                    <button class="link-action-btn copy" onclick="copiarLinkResultado()">
                        üìã Copiar
                    </button>
                </div>
            </div>

            <button class="link-action-btn close-link" style="width: 100%;" onclick="fecharLinkResult()">
                Fechar
            </button>
            <div class="link-info" id="linkInfo">
                Envie para a pessoa ou compartilhe no grupo do WhatsApp
            </div>
        </div>
    </div>

    <!-- CONFIRM MODAL -->
    <div id="confirmModal" class="confirm-overlay">
        <div class="confirm-box">
            <div class="confirm-icon" id="confirmIcon" style="background: rgba(255,69,0,0.08); border: 1px solid rgba(255,69,0,0.15);">‚ö†Ô∏è</div>
            <div class="confirm-title" id="confirmTitle">Confirmar?</div>
            <div class="confirm-text" id="confirmText">Tem certeza?</div>
            <div class="confirm-btns">
                <button class="confirm-btn primary" id="confirmYes">Confirmar</button>
                <button class="confirm-btn ghost-btn" onclick="fecharConfirm()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ============ CONFIG ============
        const SUPABASE_URL = 'https://ibchbcxtzngihxjschgl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImliY2hiY3h0em5naWh4anNjaGdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MTYyNzYsImV4cCI6MjA4NTI5MjI3Nn0.ybBzyBWFQIvw6EV3F_xQwvXHJBX7wTsm05xEgRqsu34';

        let supabaseClient = null;
        let todosEventos = [];
        let todosParticipantes = [];
        let profilesMap = {};
        let currentTab = 'ativos';
        let currentUserId = null;

        const PRECOS = {
            'Quadra 1': 75,
            'Quadra 2': 85,
            'Quadra 3': 85,
            'Campo Oficial': 190,
            'Mini Campo': 75
        };

        let sched = {
            quadra: '',
            preco: 0,
            modo: 'individual',
            jogadores: 10,
            pago: false
        };

        // ============ TOAST ============
        function showToast(msg, type = 'info') {
            const c = document.getElementById('toastContainer');
            const t = document.createElement('div');
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
            t.className = 'toast toast-' + type;
            t.textContent = icon + '  ' + msg;
            c.appendChild(t);
            setTimeout(() => { if (t.parentNode) t.remove(); }, 3500);
        }

        // ============ CONFIRM MODAL ============
        function showConfirm(title, text, btnText, btnClass, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmText').innerHTML = text;
            const btn = document.getElementById('confirmYes');
            btn.textContent = btnText;
            btn.className = 'confirm-btn ' + btnClass;
            btn.onclick = () => { fecharConfirm(); callback(); };
            document.getElementById('confirmModal').classList.add('active');
        }
        function fecharConfirm() { document.getElementById('confirmModal').classList.remove('active'); }

        // ============ INIT ============
        window.onload = async function() {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const hoje = new Date().toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' });
            document.getElementById('dataHoje').textContent = hoje.toUpperCase();
            await verificarLogin();
            await carregarDados();
        };

        async function verificarLogin() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                showToast('Acesso restrito. Fa√ßa login.', 'error');
                setTimeout(() => window.location.href = 'index.html', 1500);
                return;
            }
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('is_owner, full_name')
                .eq('id', session.user.id)
                .single();

            if (!profile || profile.is_owner !== true) {
                showToast('Acesso negado. √Årea exclusiva do propriet√°rio.', 'error');
                setTimeout(() => window.location.href = 'admin.html', 1500);
                return;
            }
            currentUserId = session.user.id;
            const nome = profile.full_name || session.user.email.split('@')[0];
            document.getElementById('ownerName').textContent = nome.toUpperCase();
        }

        // ============ CARREGAR DADOS ============
        async function carregarDados() {
            try {
                // 1. Buscar todos agendamentos
                const { data: eventos, error: e1 } = await supabaseClient
                    .from('agendamentos')
                    .select('*')
                    .order('data_jogo', { ascending: false });
                if (e1) throw e1;
                todosEventos = eventos || [];

                // 2. Buscar todos participantes
                const { data: parts, error: e2 } = await supabaseClient
                    .from('participantes_jogo')
                    .select('*');
                if (e2) throw e2;
                todosParticipantes = parts || [];

                // 3. Buscar nomes dos admins
                const userIds = [...new Set(todosEventos.map(e => e.user_id).filter(Boolean))];
                if (userIds.length > 0) {
                    const { data: profiles } = await supabaseClient
                        .from('profiles')
                        .select('id, full_name, email')
                        .in('id', userIds);
                    if (profiles) {
                        profiles.forEach(p => {
                            profilesMap[p.id] = p.full_name || (p.email ? p.email.split('@')[0] : 'Admin');
                        });
                    }
                }

                // 4. Enriquecer eventos
                todosEventos.forEach(ev => {
                    const p = todosParticipantes.filter(pp => pp.agendamento_id === ev.id);
                    ev._participantes = p;
                    ev._inscritos = p.length;
                    ev._pagos = p.filter(pp => pp.status_pagamento === 'pago').length;
                    ev._adminNome = profilesMap[ev.user_id] || 'Admin';
                });

                // 5. Popular filtro de admins
                const adminSelect = document.getElementById('filtroAdmin');
                const adminsUnicos = [...new Set(todosEventos.map(e => e.user_id).filter(Boolean))];
                adminsUnicos.forEach(uid => {
                    const opt = document.createElement('option');
                    opt.value = uid;
                    opt.textContent = profilesMap[uid] || 'Admin';
                    adminSelect.appendChild(opt);
                });

                calcularEstatisticas();
                renderEventos();

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch(e) {
                console.error('Erro ao carregar:', e);
                showToast('Erro ao carregar dados: ' + e.message, 'error');
                document.getElementById('loadingState').innerHTML = '<p style="color: var(--danger); font-size: 12px;">Erro ao carregar dados. Recarregue a p√°gina.</p>';
            }
        }

        // ============ ESTAT√çSTICAS ============
        function calcularEstatisticas() {
            const hojeISO = new Date().toISOString().split('T')[0];
            const ativos = todosEventos.filter(e => e.status !== 'cancelado');
            let receita = 0, pendente = 0, jogadores = 0, pendenteCount = 0;

            todosParticipantes.forEach(p => {
                const ev = todosEventos.find(e => e.id === p.agendamento_id);
                if (!ev || ev.status === 'cancelado') return;
                jogadores++;
                const valor = parseFloat(ev.valor_por_pessoa || 0);
                if (p.status_pagamento === 'pago') {
                    receita += valor;
                } else {
                    pendente += valor;
                    pendenteCount++;
                }
            });

            document.getElementById('totalEventos').textContent = ativos.length;
            document.getElementById('totalReceita').textContent = formatMoeda(receita);
            document.getElementById('totalPendente').textContent = formatMoeda(pendente);
            document.getElementById('totalJogadores').textContent = jogadores;

            // Tab counts
            const jogosHoje = todosEventos.filter(e => e.data_jogo === hojeISO && e.status !== 'cancelado');
            const jogosFuturos = todosEventos.filter(e => e.data_jogo >= hojeISO && e.status !== 'cancelado');
            const jogosPassados = todosEventos.filter(e => e.data_jogo < hojeISO);
            document.getElementById('countAtivos').textContent = jogosFuturos.length;
            document.getElementById('countHoje').textContent = jogosHoje.length;
            document.getElementById('countPassados').textContent = jogosPassados.length;

            // Alert
            if (pendenteCount > 0) {
                document.getElementById('alertPendencias').style.display = 'block';
                document.getElementById('alertText').innerHTML = `<strong>${pendenteCount} pagamento${pendenteCount > 1 ? 's' : ''} pendente${pendenteCount > 1 ? 's' : ''}</strong> ‚Äî Total de ${formatMoeda(pendente)} a receber`;
            } else {
                document.getElementById('alertPendencias').style.display = 'none';
            }
        }

        // ============ RENDER ============
        function renderEventos() {
            const hojeISO = new Date().toISOString().split('T')[0];
            const amanha = new Date(); amanha.setDate(amanha.getDate() + 1);
            const amanhaISO = amanha.toISOString().split('T')[0];

            let eventos = filtrarPorTab(todosEventos);
            eventos = filtrarPorInputs(eventos);

            if (eventos.length === 0) {
                document.getElementById('eventsContainer').innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            document.getElementById('emptyState').style.display = 'none';

            // Agrupar por data
            const grupos = {};
            eventos.forEach(ev => {
                const d = ev.data_jogo;
                if (!grupos[d]) grupos[d] = [];
                grupos[d].push(ev);
            });

            const datasOrdenadas = Object.keys(grupos).sort((a, b) => {
                if (currentTab === 'passados') return b.localeCompare(a);
                return a.localeCompare(b);
            });

            let html = '';
            datasOrdenadas.forEach(data => {
                let labelData, dotClass;
                if (data === hojeISO) { labelData = 'Hoje ‚Äî ' + formatData(data); dotClass = 'today'; }
                else if (data === amanhaISO) { labelData = 'Amanh√£ ‚Äî ' + formatData(data); dotClass = 'tomorrow'; }
                else if (data < hojeISO) { labelData = formatDataFull(data); dotClass = 'past'; }
                else { labelData = formatDataFull(data); dotClass = 'future'; }

                html += `<div class="date-group">`;
                html += `<div class="date-label"><span class="date-dot ${dotClass}"></span>${labelData}</div>`;
                grupos[data].forEach(ev => { html += renderEventCard(ev); });
                html += `</div>`;
            });

            document.getElementById('eventsContainer').innerHTML = html;
        }

        function renderEventCard(ev) {
            const isRacha = ev.racha_ativo;
            const avatarClass = isRacha ? 'racha' : 'individual';
            const avatarIcon = isRacha ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 3l2.5 2-1 3h-3l-1-3L12 5zm-5.5 5.5l2.5-1 1.5 2.5-2 2.5H5.5l-.5-2 1.5-2zm11 0l1.5 2-.5 2h-3l-2-2.5 1.5-2.5 2.5 1zM7 16l1-2h8l1 2-2 2.5h-6L7 16z" fill="currentColor" opacity="0.3"/></svg>' : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="8" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>';
            const tipo = isRacha ? `Racha ¬∑ ${ev.num_jogadores}p` : 'Individual';
            const adminNome = ev._adminNome || 'Admin';
            const inscritos = ev._inscritos || 0;
            const pagos = ev._pagos || 0;
            const max = isRacha ? ev.num_jogadores : 1;
            const progressPct = max > 0 ? Math.round((inscritos / max) * 100) : 0;
            const payPct = inscritos > 0 ? Math.round((pagos / inscritos) * 100) : 0;

            const valorTotal = parseFloat(ev.valor_total || 0);
            const valorPorPessoa = parseFloat(ev.valor_por_pessoa || valorTotal);
            const valorPago = pagos * valorPorPessoa;
            const valorPendente = (inscritos - pagos) * valorPorPessoa;
            let valorClass = 'paid';
            if (valorPendente > 0 && valorPago > 0) valorClass = 'partial';
            else if (valorPago === 0 && inscritos > 0) valorClass = 'unpaid';

            const statusClass = ev.status || 'interesse';

            let card = `
            <div class="event-card ${statusClass}" id="card-${ev.id}">
                <div class="event-head" onclick="toggleEvent('${ev.id}')">
                    <div class="event-avatar ${avatarClass}">${avatarIcon}</div>
                    <div class="event-info">
                        <div class="event-admin">${adminNome}</div>
                        <div class="event-details">
                            <span>${ev.sub_recurso}</span> ¬∑ ${ev.hora_inicio}‚Äì${ev.hora_fim || '?'} ¬∑ ${ev.duracao}h ¬∑ ${tipo}
                        </div>`;

            if (isRacha) {
                const fillClass = payPct === 100 ? 'green' : 'orange';
                card += `
                        <div class="progress-wrap">
                            <div class="progress-bar"><div class="progress-fill ${fillClass}" style="width:${progressPct}%"></div></div>
                            <div class="progress-text">${inscritos}/${max} jogadores ¬∑ ${pagos} pagos</div>
                        </div>`;
            }

            card += `
                    </div>
                    <div class="event-right">
                        <div class="event-value ${valorClass}">${formatMoeda(valorTotal)}</div>
                        <div class="event-status ${statusClass}">${statusClass}</div>
                    </div>
                    <div class="event-chevron" id="chevron-${ev.id}"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 4.5L6 7.5L9 4.5"/></svg></div>
                </div>

                <div class="event-body" id="body-${ev.id}">
                    <div class="event-meta">
                        <div class="meta-item">
                            <div class="meta-label">Quadra</div>
                            <div class="meta-value">${ev.sub_recurso}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Hor√°rio</div>
                            <div class="meta-value">${ev.hora_inicio} ‚Äî ${ev.hora_fim || '?'}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Dura√ß√£o</div>
                            <div class="meta-value">${ev.duracao}h</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Valor Total</div>
                            <div class="meta-value" style="color: var(--success);">${formatMoeda(valorTotal)}</div>
                        </div>`;

            if (isRacha) {
                card += `
                        <div class="meta-item">
                            <div class="meta-label">Valor / Pessoa</div>
                            <div class="meta-value">${formatMoeda(valorPorPessoa)}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Recebido</div>
                            <div class="meta-value" style="color: var(--success);">${formatMoeda(valorPago)}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">A receber</div>
                            <div class="meta-value" style="color: ${valorPendente > 0 ? 'var(--warn)' : 'var(--success)'};">${formatMoeda(valorPendente)}</div>
                        </div>`;
            }

            card += `
                        <div class="meta-item">
                            <div class="meta-label">Criado por</div>
                            <div class="meta-value" style="color: var(--arena);">${adminNome}</div>
                        </div>
                    </div>`;

            // Participantes
            const parts = ev._participantes || [];
            if (parts.length > 0 || isRacha) {
                card += `<div class="p-list"><div class="p-list-header">Participantes (${parts.length}${isRacha ? '/' + max : ''})</div>`;
                if (parts.length === 0) {
                    card += `<div style="text-align:center; padding: 16px; color: var(--muted); font-size: 11px;">Nenhum inscrito ainda</div>`;
                } else {
                    parts.forEach(p => {
                        const sc = p.status_pagamento === 'pago' ? 'pago' : 'pendente';
                        const nomeEsc = (p.nome_jogador || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        card += `
                        <div class="p-row ${sc}" id="prow-${p.id}">
                            <div style="flex:1; min-width:0;">
                                <div class="p-name">${p.nome_jogador}</div>
                                <div class="p-contact">${p.telefone || '-'}${p.email ? ' &middot; ' + p.email : ''}</div>
                            </div>
                            <div class="p-badge ${sc}">${sc === 'pago' ? 'PAGO' : 'PENDENTE'}</div>
                            <div class="p-actions">
                                <button class="p-action-btn toggle-pay" onclick="togglePagamento('${p.id}', '${sc}', '${nomeEsc}')" title="${sc === 'pago' ? 'Desmarcar pago' : 'Marcar pago'}">
                                    ${sc === 'pago' ? '‚Ü©' : '‚úì'}
                                </button>
                                <button class="p-action-btn delete" onclick="removerParticipante('${p.id}', '${nomeEsc}', '${ev.id}')" title="Remover">‚úï</button>
                            </div>
                        </div>`;
                    });
                }
                card += `</div>`;
            }

            // Actions
            card += `<div class="event-actions">`;
            if (ev.status === 'cancelado') {
                card += `<button class="ev-btn success" onclick="restaurarEvento('${ev.id}')">Restaurar</button>`;
            } else {
                card += `<button class="ev-btn danger" onclick="cancelarEvento('${ev.id}')">Cancelar</button>`;
            }
            if (ev.status === 'interesse') {
                card += `<button class="ev-btn success" onclick="confirmarEvento('${ev.id}')">Confirmar</button>`;
            }
            if (ev.link_convite) {
                const url = window.location.origin + '/convite.html?id=' + ev.link_convite;
                card += `<button class="ev-btn" onclick="copiarLink('${url}')">Copiar Link</button>`;
                const quadraEsc = (ev.sub_recurso || '').replace(/'/g, "\\'");
                card += `<button class="ev-btn" onclick="compartilharWhatsApp('${url}', '${quadraEsc}')">WhatsApp</button>`;
            }
            card += `<button class="ev-btn danger" onclick="excluirEvento('${ev.id}')">Excluir</button>`;
            card += `</div></div></div>`;

            return card;
        }

        function toggleEvent(id) {
            const body = document.getElementById('body-' + id);
            const chevron = document.getElementById('chevron-' + id);
            body.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        // ============ TABS ============
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            renderEventos();
        }

        function filtrarPorTab(eventos) {
            const hojeISO = new Date().toISOString().split('T')[0];
            switch (currentTab) {
                case 'hoje': return eventos.filter(e => e.data_jogo === hojeISO && e.status !== 'cancelado');
                case 'ativos': return eventos.filter(e => e.data_jogo >= hojeISO && e.status !== 'cancelado');
                case 'passados': return eventos.filter(e => e.data_jogo < hojeISO);
                case 'todos': return eventos;
                default: return eventos;
            }
        }

        function filtrarPorInputs(eventos) {
            const di = document.getElementById('filtroDataInicio').value;
            const df = document.getElementById('filtroDataFim').value;
            const q = document.getElementById('filtroQuadra').value;
            const a = document.getElementById('filtroAdmin').value;
            return eventos.filter(e => {
                if (di && e.data_jogo < di) return false;
                if (df && e.data_jogo > df) return false;
                if (q && e.sub_recurso !== q) return false;
                if (a && e.user_id !== a) return false;
                return true;
            });
        }

        function aplicarFiltros() { renderEventos(); }
        function limparFiltros() {
            document.getElementById('filtroDataInicio').value = '';
            document.getElementById('filtroDataFim').value = '';
            document.getElementById('filtroQuadra').value = '';
            document.getElementById('filtroAdmin').value = '';
            renderEventos();
        }

        // ============ SUPER USER ACTIONS ============

        async function togglePagamento(participanteId, statusAtual, nome) {
            const novoStatus = statusAtual === 'pago' ? 'pendente' : 'pago';
            const acao = novoStatus === 'pago' ? 'Marcar como pago' : 'Desmarcar pagamento';
            showConfirm(
                acao,
                `${acao} de <strong style="color:white;">${nome}</strong>?`,
                acao,
                novoStatus === 'pago' ? 'primary' : 'danger-btn',
                async () => {
                    try {
                        const { error } = await supabaseClient
                            .from('participantes_jogo')
                            .update({
                                status_pagamento: novoStatus,
                                data_pagamento: novoStatus === 'pago' ? new Date().toISOString() : null
                            })
                            .eq('id', participanteId);
                        if (error) throw error;
                        showToast(nome + (novoStatus === 'pago' ? ' ‚Äî pago' : ' ‚Äî desmarcado'), 'success');
                        await recarregarTudo();
                    } catch(e) {
                        showToast('Erro: ' + e.message, 'error');
                    }
                }
            );
        }

        async function removerParticipante(id, nome, eventoId) {
            showConfirm(
                'Remover Participante',
                `Remover <strong style="color:white;">${nome}</strong> deste evento?`,
                'Remover',
                'danger-btn',
                async () => {
                    try {
                        const { data: deleted, error } = await supabaseClient
                            .from('participantes_jogo')
                            .delete()
                            .eq('id', id)
                            .select();
                        if (error) throw error;
                        if (!deleted || deleted.length === 0) {
                            showToast('Sem permiss√£o. Rode o SQL de permiss√µes no Supabase.', 'error');
                            return;
                        }
                        showToast(nome + ' removido', 'success');
                        await recarregarTudo();
                    } catch(e) {
                        showToast('Erro: ' + e.message, 'error');
                    }
                }
            );
        }

        async function cancelarEvento(id) {
            showConfirm(
                'Cancelar Evento',
                'Cancelar este evento? Os participantes n√£o ser√£o removidos.',
                'Cancelar Evento',
                'danger-btn',
                async () => {
                    try {
                        const { error } = await supabaseClient
                            .from('agendamentos')
                            .update({ status: 'cancelado' })
                            .eq('id', id);
                        if (error) throw error;
                        showToast('Evento cancelado', 'success');
                        await recarregarTudo();
                    } catch(e) {
                        showToast('Erro: ' + e.message, 'error');
                    }
                }
            );
        }

        async function restaurarEvento(id) {
            showConfirm(
                'Restaurar Evento',
                'Restaurar para status confirmado?',
                'Restaurar',
                'primary',
                async () => {
                    try {
                        const { error } = await supabaseClient
                            .from('agendamentos')
                            .update({ status: 'confirmado' })
                            .eq('id', id);
                        if (error) throw error;
                        showToast('Evento restaurado', 'success');
                        await recarregarTudo();
                    } catch(e) {
                        showToast('Erro: ' + e.message, 'error');
                    }
                }
            );
        }

        async function confirmarEvento(id) {
            showConfirm(
                'Confirmar Evento',
                'Confirmar este evento manualmente?',
                'Confirmar',
                'primary',
                async () => {
                    try {
                        const { error } = await supabaseClient
                            .from('agendamentos')
                            .update({ status: 'confirmado' })
                            .eq('id', id);
                        if (error) throw error;
                        showToast('Evento confirmado', 'success');
                        await recarregarTudo();
                    } catch(e) {
                        showToast('Erro: ' + e.message, 'error');
                    }
                }
            );
        }

        async function excluirEvento(id) {
            showConfirm(
                'Excluir Permanentemente',
                'A√ß√£o <strong style="color: var(--danger);">irrevers√≠vel</strong>. Evento e participantes ser√£o apagados.',
                'Excluir',
                'danger-btn',
                async () => {
                    try {
                        await supabaseClient.from('participantes_jogo').delete().eq('agendamento_id', id);
                        await supabaseClient.from('pagamentos').delete().eq('agendamento_id', id);
                        const { error } = await supabaseClient.from('agendamentos').delete().eq('id', id);
                        if (error) throw error;
                        showToast('Evento exclu√≠do', 'success');
                        await recarregarTudo();
                    } catch(e) {
                        showToast('Erro: ' + e.message, 'error');
                    }
                }
            );
        }

        function copiarLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copiado!', 'success');
            }).catch(() => {
                showToast('Erro ao copiar', 'error');
            });
        }

        function compartilharWhatsApp(url, quadra) {
            const msg = encodeURIComponent(`‚öΩ Bora jogar!\nüìç ${quadra} ‚Äî Top Soccer Excellence\n\nüîó Se inscreva aqui:\n${url}`);
            window.open('https://wa.me/?text=' + msg, '_blank');
        }

        // ============ LINK RESULT ============
        let _linkResultUrl = '';
        let _linkPagamentoUrl = null;

        // Guardar dados pendentes para mostrar ap√≥s fechar regras
        let _pendingLinkData = null;

        function fecharRegrasEMostrarLinks() {
            document.getElementById('regrasReservaModal').classList.remove('active');
            if (_pendingLinkData) {
                _exibirLinksResult(_pendingLinkData);
                _pendingLinkData = null;
            }
        }

        function mostrarLinkResult(nome, url, quadra, dataJogo, hora, duracao, urlPagamento) {
            _linkResultUrl = url;
            _linkPagamentoUrl = urlPagamento || null;

            // Modo individual com pagamento: mostrar regras ANTES
            if (urlPagamento) {
                _pendingLinkData = { nome, url, quadra, dataJogo, hora, duracao, urlPagamento };
                document.getElementById('regrasReservaModal').classList.add('active');
                return;
            }

            // Racha: mostrar links direto
            _exibirLinksResult({ nome, url, quadra, dataJogo, hora, duracao, urlPagamento });
        }

        function _exibirLinksResult(d) {
            const { nome, url, quadra, dataJogo, hora, duracao, urlPagamento } = d;
            _linkResultUrl = url;
            _linkPagamentoUrl = urlPagamento || null;
            const [a, m, dd] = dataJogo.split('-');
            const duracaoLabel = duracao === Math.floor(duracao) ? `${duracao}h` : `${Math.floor(duracao)}h30`;
            document.getElementById('linkResultSubtitle').textContent = `${nome} ‚Äî ${quadra} ¬∑ ${dd}/${m} ¬∑ ${hora} (${duracaoLabel})`;
            document.getElementById('linkResultUrl').textContent = url;

            // Modo individual: mostrar 2 links
            if (urlPagamento) {
                document.getElementById('linkPagamentoArea').style.display = 'block';
                document.getElementById('linkPagamentoUrl').textContent = urlPagamento;
                document.getElementById('linkConviteLabel').textContent = 'üë• Link de Convite (apenas confirma√ß√£o de presen√ßa)';
                document.getElementById('linkInfo').textContent = 'üí≥ Envie o LINK DE PAGAMENTO para quem vai pagar. üë• Envie o LINK DE CONVITE para os demais jogadores.';
            } else {
                document.getElementById('linkPagamentoArea').style.display = 'none';
                document.getElementById('linkConviteLabel').textContent = 'üë• Link de Convite (inscri√ß√£o + pagamento)';
                document.getElementById('linkInfo').textContent = 'Envie para a pessoa ou compartilhe no grupo do WhatsApp';
            }

            document.getElementById('linkResultModal').classList.add('active');
            navigator.clipboard.writeText(url).catch(() => {});
        }

        function copiarLinkResultado() {
            navigator.clipboard.writeText(_linkResultUrl).then(() => {
                showToast('Link de convite copiado!', 'success');
            }).catch(() => {
                showToast('Erro ao copiar', 'error');
            });
        }

        function copiarLinkEspecifico(elementId) {
            const texto = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(texto).then(() => {
                showToast('Link copiado!', 'success');
            }).catch(() => {
                prompt('Copie o link:', texto);
            });
        }

        function enviarWhatsApp(tipo) {
            const sub = document.getElementById('linkResultSubtitle').textContent;
            let url, textoAcao;
            if (tipo === 'pagamento' && _linkPagamentoUrl) {
                url = _linkPagamentoUrl;
                textoAcao = 'Pague aqui para confirmar a reserva';
            } else {
                url = _linkResultUrl;
                textoAcao = 'Confirme sua presen√ßa aqui';
            }
            const msg = encodeURIComponent(`‚öΩ Bora jogar!\nüèüÔ∏è ${sub}\nüèÜ Top Soccer Excellence\n\nüîó ${textoAcao}:\n${url}`);
            window.open('https://wa.me/?text=' + msg, '_blank');
        }

        function fecharLinkResult() {
            document.getElementById('linkResultModal').classList.remove('active');
        }

        // ============ RECARREGAR ============
        async function recarregarTudo() {
            const { data: eventos } = await supabaseClient
                .from('agendamentos')
                .select('*')
                .order('data_jogo', { ascending: false });
            todosEventos = eventos || [];

            const { data: parts } = await supabaseClient
                .from('participantes_jogo')
                .select('*');
            todosParticipantes = parts || [];

            todosEventos.forEach(ev => {
                const p = todosParticipantes.filter(pp => pp.agendamento_id === ev.id);
                ev._participantes = p;
                ev._inscritos = p.length;
                ev._pagos = p.filter(pp => pp.status_pagamento === 'pago').length;
                ev._adminNome = profilesMap[ev.user_id] || 'Admin';
            });

            calcularEstatisticas();
            renderEventos();
        }

        // ============ NOVO AGENDAMENTO ============

        function abrirAgendamento() {
            // Reset form
            document.getElementById('schedNome').value = '';
            document.getElementById('schedTelefone').value = '';
            document.getElementById('schedEmail').value = '';
            document.getElementById('schedData').value = new Date().toISOString().split('T')[0];
            document.getElementById('schedStatus').value = 'confirmado';
            sched = { quadra: '', preco: 0, modo: 'individual', jogadores: 10, pago: false };

            // Reset quadra selection
            document.querySelectorAll('.quadra-opt').forEach(q => q.classList.remove('selected'));

            // Reset mode
            document.getElementById('modeIndividual').classList.add('selected');
            document.getElementById('modeRacha').classList.remove('selected');
            document.getElementById('rachaConfig').classList.remove('show');
            document.getElementById('schedJogadoresNum').textContent = '10';

            // Reset pago
            document.getElementById('payNao').classList.remove('selected');
            document.getElementById('paySim').classList.remove('selected');

            // Populate hours inicio
            const horaSelect = document.getElementById('schedHoraInicio');
            horaSelect.innerHTML = '';
            for (let h = 7; h <= 23; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const t = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
                    horaSelect.innerHTML += `<option value="${t}">${t}</option>`;
                }
            }

            // Populate hora fim
            popularHoraFim();

            atualizarSummary();
            document.getElementById('scheduleModal').classList.add('active');
        }

        function fecharAgendamento() {
            document.getElementById('scheduleModal').classList.remove('active');
        }

        function setSchedQuadra(nome, el) {
            sched.quadra = nome;
            sched.preco = PRECOS[nome] || 75;
            document.querySelectorAll('.quadra-opt').forEach(q => q.classList.remove('selected'));
            el.classList.add('selected');
            atualizarSummary();
        }

        function setSchedModo(modo) {
            sched.modo = modo;
            document.getElementById('modeIndividual').classList.toggle('selected', modo === 'individual');
            document.getElementById('modeRacha').classList.toggle('selected', modo === 'racha');
            document.getElementById('rachaConfig').classList.toggle('show', modo === 'racha');
            atualizarSummary();
        }

        function mudarSchedJogadores(d) {
            sched.jogadores += d;
            if (sched.jogadores < 2) sched.jogadores = 2;
            if (sched.jogadores > 40) sched.jogadores = 40;
            document.getElementById('schedJogadoresNum').textContent = sched.jogadores;
            atualizarSummary();
        }

        function setSchedPago(pago) {
            sched.pago = pago;
            document.getElementById('payNao').classList.toggle('selected', !pago);
            document.getElementById('paySim').classList.toggle('selected', pago);
        }

        function popularHoraFim() {
            const horaInicio = document.getElementById('schedHoraInicio').value;
            const fimSelect = document.getElementById('schedHoraFim');
            fimSelect.innerHTML = '';

            if (!horaInicio) return;

            const [hh, mm] = horaInicio.split(':').map(Number);
            const inicioMin = hh * 60 + mm;

            // Opcoes de 30min apos inicio ate 24:00 (maximo 4h)
            for (let add = 30; add <= 240; add += 30) {
                const fimMin = inicioMin + add;
                if (fimMin > 24 * 60) break;
                const fH = String(Math.floor(fimMin / 60)).padStart(2, '0');
                const fM = String(fimMin % 60).padStart(2, '0');
                const horas = add / 60;
                const label = horas === Math.floor(horas) ? `${fH}:${fM} (${horas}h)` : `${fH}:${fM} (${Math.floor(horas)}h30)`;
                const sel = add === 60 ? ' selected' : '';
                fimSelect.innerHTML += `<option value="${fH}:${fM}"${sel}>${label}</option>`;
            }
        }

        function calcDuracao() {
            const horaInicio = document.getElementById('schedHoraInicio').value;
            const horaFim = document.getElementById('schedHoraFim').value;
            if (!horaInicio || !horaFim) return 1;
            const [h1, m1] = horaInicio.split(':').map(Number);
            const [h2, m2] = horaFim.split(':').map(Number);
            const diff = (h2 * 60 + m2) - (h1 * 60 + m1);
            return diff > 0 ? diff / 60 : 1;
        }

        function atualizarSummary() {
            const duracao = calcDuracao();
            const total = duracao * sched.preco;
            const porPessoa = sched.modo === 'racha' ? (total / sched.jogadores) : total;

            document.getElementById('sumQuadra').textContent = sched.quadra || '\u2014';

            const horaInicio = document.getElementById('schedHoraInicio').value;
            const horaFim = document.getElementById('schedHoraFim').value;
            if (horaInicio && horaFim) {
                const duracaoLabel = duracao === Math.floor(duracao) ? `${duracao}h` : `${Math.floor(duracao)}h30`;
                document.getElementById('sumHorario').textContent = `${horaInicio} \u2014 ${horaFim} (${duracaoLabel})`;
            } else {
                document.getElementById('sumHorario').textContent = '\u2014';
            }

            document.getElementById('sumTotal').textContent = sched.preco > 0 ? formatMoeda(total) : '\u2014';

            if (sched.modo === 'racha') {
                document.getElementById('sumPessoaRow').style.display = 'flex';
                document.getElementById('sumPessoa').textContent = formatMoeda(porPessoa);
            } else {
                document.getElementById('sumPessoaRow').style.display = 'none';
            }
        }

        // Live update summary on input change
        document.addEventListener('change', function(e) {
            if (e.target.id === 'schedHoraInicio') { popularHoraFim(); atualizarSummary(); }
            if (e.target.id === 'schedHoraFim') atualizarSummary();
        });

        async function criarNovoAgendamento() {
            const nome = document.getElementById('schedNome').value.trim();
            const telefone = document.getElementById('schedTelefone').value.trim();
            const email = document.getElementById('schedEmail').value.trim();
            const data = document.getElementById('schedData').value;
            const horaInicio = document.getElementById('schedHoraInicio').value;
            const horaFimVal = document.getElementById('schedHoraFim').value;
            const duracao = calcDuracao();
            const status = document.getElementById('schedStatus').value;

            // Validations
            if (!nome) { showToast('Informe o nome da pessoa', 'error'); return; }
            if (!sched.quadra) { showToast('Selecione a quadra', 'error'); return; }
            if (!data) { showToast('Selecione a data', 'error'); return; }
            if (!horaInicio) { showToast('Selecione o hor√°rio', 'error'); return; }

            const btn = document.getElementById('btnCriarAgendamento');
            btn.disabled = true;
            btn.textContent = 'CRIANDO...';

            try {
                const total = duracao * sched.preco;
                const numJogadores = sched.modo === 'racha' ? sched.jogadores : 1;
                const valorPorPessoa = sched.modo === 'racha' ? (total / numJogadores) : total;
                const horaFim = horaFimVal;

                // Gerar link √∫nico para todos os modos
                const linkConvite = crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0; return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16); });

                // 1. Create agendamento
                const { data: agendamento, error: err1 } = await supabaseClient
                    .from('agendamentos')
                    .insert({
                        user_id: currentUserId,
                        tipo_recurso: 'Arena',
                        sub_recurso: sched.quadra,
                        data_jogo: data,
                        hora_inicio: horaInicio,
                        hora_fim: horaFim,
                        duracao: duracao,
                        status: status,
                        racha_ativo: sched.modo === 'racha',
                        num_jogadores: numJogadores,
                        valor_por_pessoa: valorPorPessoa,
                        valor_total: total,
                        link_convite: linkConvite
                    })
                    .select()
                    .single();

                if (err1) throw err1;

                // 2. Add the person as participant
                const { error: err2 } = await supabaseClient
                    .from('participantes_jogo')
                    .insert({
                        agendamento_id: agendamento.id,
                        nome_jogador: nome,
                        telefone: telefone || null,
                        email: email || null,
                        status_pagamento: sched.pago ? 'pago' : 'pendente',
                        data_pagamento: sched.pago ? new Date().toISOString() : null,
                        data_inscricao: new Date().toISOString()
                    });

                if (err2) throw err2;

                fecharAgendamento();

                // Gerar links
                const conviteUrl = window.location.origin + '/convite.html?id=' + agendamento.link_convite;
                
                // Modo individual: gerar tamb√©m link de pagamento separado
                let pagamentoUrl = null;
                if (sched.modo === 'individual') {
                    pagamentoUrl = window.location.origin + '/convite.html?id=' + agendamento.link_convite + '&tipo=pagamento';
                }
                
                mostrarLinkResult(nome, conviteUrl, sched.quadra, data, horaInicio, duracao, pagamentoUrl);

                await recarregarTudo();

            } catch (e) {
                console.error('Erro ao criar agendamento:', e);
                showToast('Erro: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'CRIAR AGENDAMENTO';
            }
        }

        // ============ UTILS ============
        function formatData(d) {
            if (!d) return '-';
            const [a, m, dia] = d.split('-');
            return `${dia}/${m}`;
        }
        function formatDataFull(d) {
            if (!d) return '-';
            const [a, m, dia] = d.split('-');
            const dt = new Date(d + 'T12:00:00');
            const dias = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'S√ÅB'];
            return `${dias[dt.getDay()]} ¬∑ ${dia}/${m}/${a}`;
        }
        function formatMoeda(v) {
            return 'R$ ' + parseFloat(v || 0).toFixed(2).replace('.', ',');
        }
        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
