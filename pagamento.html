<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento | Top Soccer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root { --arena: #FF4500; --bg: #050505; --card: #111; --success: #39FF14; }

        /* TOAST NOTIFICATION */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 14px 20px; border-radius: 12px; color: white; font-size: 13px; font-weight: 700; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: toastIn 0.3s ease, toastOut 0.3s ease forwards; animation-delay: 0s, 3s; max-width: 350px; backdrop-filter: blur(10px); }
        .toast-success { background: rgba(57,255,20,0.2); border: 1px solid #39FF14; }
        .toast-error { background: rgba(255,0,64,0.2); border: 1px solid #FF0040; }
        .toast-info { background: rgba(255,69,0,0.2); border: 1px solid #FF4500; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #000 0%, #1a1a1a 100%); color: white; font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .font-impact { font-family: 'Archivo Black', sans-serif; text-transform: uppercase; font-style: italic; }
        
        .container { max-width: 500px; width: 100%; }
        .card { background: var(--card); border-radius: 30px; padding: 40px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.5); margin-bottom: 20px; }
        
        .icon { width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .icon-payment { background: linear-gradient(135deg, rgba(255,69,0,0.3), rgba(255,69,0,0.1)); border: 2px solid var(--arena); }
        .icon-success { background: linear-gradient(135deg, rgba(57,255,20,0.3), rgba(57,255,20,0.1)); border: 2px solid var(--success); animation: pulse 2s infinite; }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(57,255,20,0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 30px 10px rgba(57,255,20,0); } }
        
        h1 { font-size: 28px; font-weight: 900; margin-bottom: 10px; text-align: center; }
        h2 { font-size: 20px; font-weight: 900; color: var(--arena); margin-bottom: 20px; }
        p { color: #888; font-size: 14px; line-height: 1.6; text-align: center; margin-bottom: 15px; }
        
        .info-box { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; margin: 25px 0; }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .info-row:last-child { border-bottom: none; }
        .info-label { font-size: 12px; color: #666; text-transform: uppercase; font-weight: 700; }
        .info-value { font-size: 14px; font-weight: 900; color: white; }
        
        .price-display { text-align: center; padding: 30px; background: rgba(255,69,0,0.1); border-radius: 20px; margin: 25px 0; border: 2px dashed var(--arena); }
        .price-label { font-size: 12px; color: #888; text-transform: uppercase; font-weight: 700; margin-bottom: 10px; }
        .price-value { font-size: 48px; font-weight: 900; color: var(--arena); line-height: 1; }
        
        /* Stripe Elements */
        #card-element { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin: 20px 0; }
        #card-errors { color: #ff5555; font-size: 13px; margin-top: 10px; text-align: center; }
        
        /* MÃ©todo de Pagamento */
        .payment-methods { display: flex; gap: 10px; margin: 25px 0; }
        .payment-method { flex: 1; padding: 20px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); cursor: pointer; transition: 0.3s; text-align: center; }
        .payment-method:hover { border-color: var(--arena); }
        .payment-method.active { border-color: var(--arena); background: rgba(255,69,0,0.1); }
        .payment-method-icon { font-size: 32px; margin-bottom: 10px; }
        .payment-method-name { font-size: 12px; font-weight: 900; text-transform: uppercase; color: white; }
        
        /* QR Code PIX */
        .pix-area { text-align: center; padding: 30px; background: rgba(255,255,255,0.03); border-radius: 20px; margin: 20px 0; }
        .qr-code { width: 250px; height: 250px; margin: 20px auto; background: white; padding: 15px; border-radius: 15px; display: flex; align-items: center; justify-content: center; }
        .qr-code img { width: 100%; height: 100%; }
        .pix-copy { background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.3); border-radius: 10px; padding: 15px; margin: 20px 0; word-break: break-all; font-size: 11px; color: #888; font-family: monospace; }
        .copy-pix-btn { background: var(--success); color: black; font-weight: 900; padding: 12px 30px; border-radius: 10px; border: none; font-size: 12px; cursor: pointer; margin-top: 15px; }
        
        .btn { width: 100%; background: var(--arena); color: black; font-weight: 900; text-transform: uppercase; padding: 18px; border-radius: 20px; border: none; font-size: 14px; letter-spacing: 2px; cursor: pointer; transition: 0.3s; box-shadow: 0 0 30px rgba(255,69,0,0.3); }
        .btn:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 0 50px rgba(255,69,0,0.5); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 50px; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--arena); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- LOADING -->
        <div id="loadingArea" class="card">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 20px;">Carregando informaÃ§Ãµes...</p>
            </div>
        </div>

        <!-- PAGAMENTO -->
        <div id="paymentArea" class="hidden">
            <div class="card">
                <div class="icon icon-payment">ğŸ’³</div>
                <h1 class="font-impact">FINALIZE SEU PAGAMENTO</h1>
                <p>Confirme seus dados e efetue o pagamento para garantir sua vaga.</p>
                
                <div class="info-box">
                    <div class="info-row">
                        <span class="info-label">ğŸ‘¤ Jogador</span>
                        <span class="info-value" id="nomeJogador">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ğŸ“… Data</span>
                        <span class="info-value" id="dataJogo">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">â° HorÃ¡rio</span>
                        <span class="info-value" id="horarioJogo">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">âš½ Quadra</span>
                        <span class="info-value" id="quadraJogo">--</span>
                    </div>
                </div>

                <div class="price-display">
                    <div class="price-label">ğŸ’° Valor a Pagar</div>
                    <div class="price-value" id="valorPagar">R$ 0,00</div>
                </div>
            </div>

            <div class="card">
                <h2>Escolha o MÃ©todo de Pagamento</h2>
                
                <div class="payment-methods">
                    <div class="payment-method active" onclick="selectPaymentMethod('card')">
                        <div class="payment-method-icon">ğŸ’³</div>
                        <div class="payment-method-name">CartÃ£o</div>
                    </div>
                    <div class="payment-method" onclick="selectPaymentMethod('pix')">
                        <div class="payment-method-icon">ğŸ“±</div>
                        <div class="payment-method-name">PIX</div>
                    </div>
                </div>

                <!-- CARTÃƒO -->
                <div id="cardArea">
                    <h2 style="margin-top: 30px;">Dados do CartÃ£o</h2>
                    <form id="payment-form">
                        <div id="card-element"></div>
                        <div id="card-errors" role="alert"></div>
                        <button type="submit" id="btnPagar" class="btn" style="margin-top: 30px;">
                            ğŸ”’ PAGAR AGORA
                        </button>
                    </form>
                </div>

                <!-- PIX -->
                <div id="pixArea" class="hidden">
                    <div class="pix-area">
                        <h2 style="margin-bottom: 20px;">Escaneie o QR Code</h2>
                        <div class="qr-code" id="qrCodeContainer">
                            <div class="spinner"></div>
                        </div>
                        <p style="font-size: 13px; color: #888; margin: 20px 0;">
                            Ou copie o cÃ³digo PIX abaixo:
                        </p>
                        <div class="pix-copy" id="pixCode">Gerando cÃ³digo...</div>
                        <button class="copy-pix-btn" onclick="copiarPixCode()">
                            ğŸ“‹ COPIAR CÃ“DIGO PIX
                        </button>
                        <p style="font-size: 12px; color: #666; margin-top: 20px;">
                            â±ï¸ Aguardando pagamento...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SUCESSO -->
        <div id="successArea" class="hidden">
            <div class="card">
                <div class="icon icon-success">âœ“</div>
                <h1 class="font-impact" style="color: var(--success);">PAGAMENTO CONFIRMADO!</h1>
                <p>Sua vaga estÃ¡ garantida! Nos vemos em campo! ğŸ‰</p>
                
                <div class="info-box">
                    <div class="info-row">
                        <span class="info-label">ğŸ“‹ Status</span>
                        <span class="info-value" style="color: var(--success);">âœ… PAGO</span>
                    </div>
                </div>
                
                <button onclick="window.location.href='index.html'" class="btn" style="margin-top: 30px;">
                    ğŸ  VOLTAR PARA INÃCIO
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // TOAST NOTIFICATION SYSTEM
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            toast.className = 'toast toast-' + type;
            toast.textContent = icon + ' ' + msg;
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 3500);
        }

        const SUPABASE_URL = 'https://ibchbcxtzngihxjschgl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImliY2hiY3h0em5naWh4anNjaGdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MTYyNzYsImV4cCI6MjA4NTI5MjI3Nn0.ybBzyBWFQIvw6EV3F_xQwvXHJBX7wTsm05xEgRqsu34';
        const STRIPE_PUBLISHABLE_KEY = 'pk_test_51T4ndfAMRrzQseDW49v6yerBz3XTEMHDPHH5gDOtcUmroqD9HHaJX39P6Olom5nV5SB9NSBpWO0YAXix80OrYZjy00drvOmETA';

        let supabaseClient = null;
        let stripe = null;
        let cardElement = null;
        let agendamentoId = null; // Pode ser reserva ou agendamento
        let agendamentoData = null;
        let tipoAgendamento = null; // 'reserva', 'agendamento' ou 'inscricao'
        let inscricaoId = null; // ID do participante (quando for racha)
        let valorTotal = 75; // Valor padrÃ£o (Quadra 1)
        let valorPagar = 0; // Valor a pagar (100% do valor)
        let paymentMethod = 'card'; // 'card' ou 'pix'
        let pixCheckInterval = null;

        window.onload = async function() {
            console.log('ğŸ”„ PÃ¡gina de pagamento carregando...');
            console.log('ğŸ“ URL completa:', window.location.href);
            
            try {
                // Verificar bibliotecas
                if (!window.supabase) {
                    console.error('âŒ Supabase nÃ£o carregado');
                    showToast('Supabase nÃ£o carregado. Recarregue a pÃ¡gina.', 'error');
                    return;
                }
                
                if (!window.Stripe) {
                    console.error('âŒ Stripe nÃ£o carregado');
                    showToast('Stripe nÃ£o carregado. Recarregue a pÃ¡gina.', 'error');
                    return;
                }
                
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                console.log('âœ… Supabase e Stripe inicializados');

                // Pegar ID da URL (pode ser 'reserva', 'agendamento' ou 'inscricao')
                console.log('ğŸ” Analisando URL:', window.location.search);
                const urlParams = new URLSearchParams(window.location.search);
                const reservaParam = urlParams.get('reserva');
                const agendamentoParam = urlParams.get('agendamento');
                const inscricaoParam = urlParams.get('inscricao');
                
                console.log('ğŸ“ ParÃ¢metros encontrados:', {
                    reserva: reservaParam,
                    agendamento: agendamentoParam,
                    inscricao: inscricaoParam
                });
                
                if (inscricaoParam) {
                    // Jogador inscrito via link do racha
                    inscricaoId = inscricaoParam;
                    tipoAgendamento = 'inscricao';
                    console.log('ğŸ« Modo: INSCRIÃ‡ÃƒO');
                    console.log('ğŸ†” ID:', inscricaoId);
                } else if (agendamentoParam) {
                    agendamentoId = agendamentoParam;
                    tipoAgendamento = 'agendamento';
                    console.log('ğŸ“‹ Modo: AGENDAMENTO');
                    console.log('ğŸ†” ID:', agendamentoId);
                } else if (reservaParam) {
                    agendamentoId = reservaParam;
                    tipoAgendamento = 'reserva';
                    console.log('ğŸ“‹ Modo: RESERVA');
                    console.log('ğŸ†” ID:', agendamentoId);
                } else {
                    console.error('âŒ Nenhum ID encontrado na URL');
                    window.location.href = 'admin.html';
                    return;
                }

                console.log('ğŸ” Tipo:', tipoAgendamento);
                console.log('ğŸ” Buscando dados...');
                await carregarDados();
                
            } catch(e) {
                console.error('âŒ Erro:', e);
                window.location.href = 'admin.html';
            }
        };

        async function carregarDados() {
            try {
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ” INICIANDO carregarDados()');
                console.log('ğŸ“ Tipo:', tipoAgendamento);
                console.log('ğŸ†” agendamentoId:', agendamentoId);
                console.log('ğŸ†” inscricaoId:', inscricaoId);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                let dados, erro;
                
                // Se for INSCRIÃ‡ÃƒO (jogador do racha)
                if (tipoAgendamento === 'inscricao') {
                    console.log('ğŸ‘¤ Buscando dados de INSCRIÃ‡ÃƒO...');
                    // Buscar dados do participante
                    const { data: participante, error: errParticipante } = await supabaseClient
                        .from('participantes_jogo')
                        .select('*')
                        .eq('id', inscricaoId)
                        .single();
                    
                    if (errParticipante || !participante) {
                        throw new Error('InscriÃ§Ã£o nÃ£o encontrada: ' + (errParticipante?.message || 'Dados invÃ¡lidos'));
                    }
                    
                    console.log('ğŸ‘¤ Participante:', participante);
                    
                    // Buscar dados do agendamento relacionado
                    const { data: agendamento, error: errAgendamento } = await supabaseClient
                        .from('agendamentos')
                        .select('*')
                        .eq('id', participante.agendamento_id)
                        .single();
                    
                    if (errAgendamento || !agendamento) {
                        throw new Error('Agendamento nÃ£o encontrado: ' + (errAgendamento?.message || 'Dados invÃ¡lidos'));
                    }
                    
                    agendamentoId = agendamento.id;
                    agendamentoData = agendamento;
                    agendamentoData.participante = participante; // Salvar dados do participante
                    
                    console.log('âœ… Dados do agendamento:', agendamento);
                    console.log('ğŸ’° Valor por pessoa:', agendamento.valor_por_pessoa);
                    
                    // Verificar se jÃ¡ pagou
                    if (participante.status_pagamento === 'pago') {
                        console.log('âš ï¸ JÃ¡ pagou!');
                        showToast('VocÃª jÃ¡ efetuou o pagamento!', 'success');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                } else if (tipoAgendamento === 'agendamento') {
                    console.log('ğŸ“… Buscando AGENDAMENTO na tabela agendamentos...');
                    console.log('ğŸ” ID buscado:', agendamentoId);
                    
                    // Buscar na tabela agendamentos
                    const { data, error } = await supabaseClient
                        .from('agendamentos')
                        .select('*')
                        .eq('id', agendamentoId)
                        .single();
                    
                    console.log('ğŸ“¥ Resposta Supabase:', { data, error });
                    
                    dados = data;
                    erro = error;
                    
                    if (erro) {
                        console.error('âŒ Erro ao buscar:', erro);
                        throw new Error('Agendamento nÃ£o encontrado: ' + erro.message);
                    }
                    
                    if (!dados) {
                        console.error('âŒ Nenhum dado retornado!');
                        throw new Error('Agendamento nÃ£o encontrado: Dados invÃ¡lidos');
                    }
                    
                    console.log('âœ… Agendamento encontrado!', dados);
                    agendamentoData = dados;
                    
                } else {
                    // Buscar na tabela reservas
                    const { data, error } = await supabaseClient
                        .from('reservas')
                        .select('*')
                        .eq('id', agendamentoId)
                        .single();
                    dados = data;
                    erro = error;
                    
                    if (erro || !dados) {
                        throw new Error('Reserva nÃ£o encontrada: ' + (erro?.message || 'Dados invÃ¡lidos'));
                    }
                    
                    agendamentoData = dados;
                }

                console.log('âœ… Dados carregados:', agendamentoData);
                console.log('ğŸ“Š Status atual:', agendamentoData.status);

                // Verificar se jÃ¡ estÃ¡ confirmado (exceto para inscriÃ§Ã£o)
                if (tipoAgendamento !== 'inscricao' && (agendamentoData.status === 'confirmado' || agendamentoData.status === 'concluido')) {
                    console.log('âš ï¸ JÃ¡ estÃ¡ pago! Status:', agendamentoData.status);
                    mostrarSucesso();
                    return;
                }
                
                // Buscar dados do usuÃ¡rio
                const { data: { user } } = await supabaseClient.auth.getUser();
                let nomeUsuario = user?.email?.split('@')[0] || 'Jogador';

                // Extrair dados conforme o tipo
                let dataJogo, quadraNome, horaInicio, horaFim;
                
                if (tipoAgendamento === 'inscricao') {
                    // Dados de um participante inscrito via link
                    const participante = agendamentoData.participante;
                    
                    dataJogo = agendamentoData.data_jogo;
                    quadraNome = agendamentoData.sub_recurso;
                    horaInicio = agendamentoData.hora_inicio;
                    horaFim = agendamentoData.hora_fim;
                    valorTotal = parseFloat(agendamentoData.valor_total) || 75;
                    valorPagar = parseFloat(agendamentoData.valor_por_pessoa); // Jogador paga sua parte
                    nomeUsuario = participante.nome_jogador; // Nome do participante
                    
                    console.log('ğŸ‘¤ Jogador inscrito:', nomeUsuario);
                    
                } else if (tipoAgendamento === 'agendamento') {
                    // Dados da tabela agendamentos
                    dataJogo = agendamentoData.data_jogo;
                    quadraNome = agendamentoData.sub_recurso;
                    horaInicio = agendamentoData.hora_inicio;
                    horaFim = agendamentoData.hora_fim;
                    valorTotal = parseFloat(agendamentoData.valor_total) || 75;
                    
                    // Paga valor total (individual) ou valor por pessoa (racha)
                    if (agendamentoData.racha_ativo) {
                        valorPagar = parseFloat(agendamentoData.valor_por_pessoa);
                    } else {
                        valorPagar = valorTotal;
                    }
                } else {
                    // Dados da tabela reservas
                    dataJogo = agendamentoData.data;
                    quadraNome = agendamentoData.quadra;
                    horaInicio = agendamentoData.hora_inicio;
                    horaFim = agendamentoData.hora_fim;
                    valorTotal = 75; // Valor padrÃ£o
                    valorPagar = valorTotal;
                }

                console.log('ğŸ’° Valor total:', valorTotal);
                console.log('ğŸ’° Valor a pagar:', valorPagar);

                // Preencher dados na tela
                $('#nomeJogador').text(nomeUsuario.toUpperCase());
                $('#dataJogo').text(formatarData(dataJogo));
                $('#horarioJogo').text(horaInicio + ' - ' + horaFim);
                $('#quadraJogo').text(quadraNome);
                $('#valorPagar').text('R$ ' + valorPagar.toFixed(2));

                // Configurar Stripe Elements
                const elements = stripe.elements();
                cardElement = elements.create('card', {
                    style: {
                        base: {
                            color: '#ffffff',
                            fontFamily: 'Inter, sans-serif',
                            fontSize: '16px',
                            '::placeholder': { color: '#888' }
                        },
                        invalid: { color: '#ff5555' }
                    }
                });
                cardElement.mount('#card-element');

                cardElement.on('change', function(event) {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });

                console.log('âœ… Stripe Elements montado com sucesso');
                console.log('ğŸ¨ Ocultando loading, mostrando formulÃ¡rio...');

                // Mostrar Ã¡rea de pagamento
                $('#loadingArea').addClass('hidden');
                $('#paymentArea').removeClass('hidden');
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ‰ PÃGINA DE PAGAMENTO PRONTA!');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            } catch(e) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ ERRO FATAL ao carregar dados:');
                console.error('Mensagem:', e.message);
                console.error('Stack:', e.stack);
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                showToast('Erro: ' + e.message, 'error');
                window.location.href = 'index.html';
            }
        }

        // Processar pagamento com cartÃ£o
        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const btn = $('#btnPagar');
            btn.prop('disabled', true).text('PROCESSANDO...');

            try {
                console.log('ğŸ”„ Iniciando pagamento...');

                // Criar Payment Method
                const { paymentMethod, error } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                });

                if (error) {
                    throw new Error(error.message);
                }

                console.log('âœ… Payment Method criado:', paymentMethod.id);

                // âš ï¸ IMPORTANTE: Em produÃ§Ã£o, vocÃª deve:
                // 1. Enviar paymentMethod.id para seu backend
                // 2. Backend cria Payment Intent no Stripe
                // 3. Backend confirma pagamento
                // 4. Backend atualiza Supabase via webhook
                
                // ğŸ§ª PARA TESTE: Vamos simular sucesso e atualizar direto
                // (Em teste, o Stripe nÃ£o cobra de verdade com cartÃ£o 4242...)
                
                console.log('ğŸ’³ Simulando pagamento de R$', valorPagar);
                
                // Registrar pagamento na tabela de pagamentos
                const porcent = 100;
                const tipoPgto = 'total';
                const pagamentoInsert = {
                    user_id: agendamentoData.user_id,
                    valor_total: valorTotal,
                    valor_pago: valorPagar,
                    porcentagem: porcent,
                    tipo: tipoPgto,
                    payment_method: 'stripe',
                    status: 'completed',
                    stripe_payment_id: paymentMethod.id
                };
                
                // Adicionar ID dependendo do tipo
                if (tipoAgendamento === 'inscricao') {
                    pagamentoInsert.agendamento_id = agendamentoId;
                } else if (tipoAgendamento === 'agendamento') {
                    pagamentoInsert.agendamento_id = agendamentoId;
                } else {
                    pagamentoInsert.reserva_id = agendamentoId;
                }
                
                const { data: pagamentoData, error: pagamentoError } = await supabaseClient
                    .from('pagamentos')
                    .insert(pagamentoInsert)
                    .select()
                    .single();

                if (pagamentoError) {
                    console.error('Erro ao registrar pagamento:', pagamentoError);
                    throw new Error('Erro ao registrar pagamento: ' + pagamentoError.message);
                }

                console.log('âœ… Pagamento registrado:', pagamentoData);

                // Atualizar status dependendo do tipo
                if (tipoAgendamento === 'inscricao') {
                    // Atualizar status do participante
                    const { error: updateError } = await supabaseClient
                        .from('participantes_jogo')
                        .update({
                            status_pagamento: 'pago',
                            data_pagamento: new Date().toISOString()
                        })
                        .eq('id', inscricaoId);

                    if (updateError) {
                        console.error('Erro ao atualizar participante:', updateError);
                        throw new Error('Erro ao confirmar participante: ' + updateError.message);
                    }

                    console.log('âœ… Participante atualizado para PAGO!');
                    
                } else {
                    // Atualizar status na tabela correta (agendamentos ou reservas)
                    const tabelaAtualizar = tipoAgendamento === 'agendamento' ? 'agendamentos' : 'reservas';
                    
                    const { error: updateError } = await supabaseClient
                        .from(tabelaAtualizar)
                        .update({
                            status: 'confirmado',
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', agendamentoId);

                    if (updateError) {
                        console.error('Erro ao atualizar:', updateError);
                        throw new Error('Erro ao confirmar: ' + updateError.message);
                    }

                    console.log('âœ… Agendamento confirmado! Status: confirmado');
                }

                // Limpar localStorage
                localStorage.removeItem('reserva_pendente_id');
                localStorage.removeItem('reserva_pendente_quadra');
                localStorage.removeItem('reserva_pendente_data');
                localStorage.removeItem('reserva_pendente_hora');
                localStorage.removeItem('agendamento_pendente_id');
                localStorage.removeItem('agendamento_pendente_quadra');
                localStorage.removeItem('agendamento_pendente_data');
                localStorage.removeItem('agendamento_pendente_hora');
                localStorage.removeItem('agendamento_pendente_valor');
                localStorage.removeItem('agendamento_pendente_modo');

                // Mostrar sucesso
                mostrarSucesso();

            } catch(e) {
                console.error('âŒ Erro no pagamento:', e);
                showToast('Erro no pagamento: ' + e.message, 'error');
                btn.prop('disabled', false).text('ğŸ”’ PAGAR AGORA');
            }
        });

        function mostrarSucesso() {
            $('#loadingArea, #paymentArea').addClass('hidden');
            $('#successArea').removeClass('hidden');
            
            // Scroll para o topo
            window.scrollTo(0, 0);
        }

        function formatarData(dataISO) {
            const [ano, mes, dia] = dataISO.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        // Selecionar mÃ©todo de pagamento
        function selectPaymentMethod(method) {
            paymentMethod = method;
            
            // Atualizar visual dos botÃµes
            $('.payment-method').removeClass('active');
            if (method === 'card') {
                $('.payment-method').eq(0).addClass('active');
                $('#cardArea').removeClass('hidden');
                $('#pixArea').addClass('hidden');
            } else {
                $('.payment-method').eq(1).addClass('active');
                $('#cardArea').addClass('hidden');
                $('#pixArea').removeClass('hidden');
                gerarPix();
            }
        }

        // Gerar PIX
        async function gerarPix() {
            try {
                console.log('ğŸ“± Gerando cÃ³digo PIX...');
                
                // âš ï¸ IMPORTANTE: Em produÃ§Ã£o, vocÃª deve:
                // 1. Gerar cÃ³digo PIX real via API do seu banco/gateway
                // 2. Usar Mercado Pago, PagSeguro ou outro gateway
                // 3. Receber notificaÃ§Ã£o via webhook quando pagar
                
                // ğŸ§ª PARA TESTE: Gerando cÃ³digo simulado
                const pixCode = `00020126580014br.gov.bcb.pix0136${generateRandomUUID()}52040000530398654${valorPagar.toFixed(2)}5802BR5925Top Soccer Excellence6009SAO PAULO62070503***6304`;
                
                // Gerar QR Code usando API gratuita
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(pixCode)}`;
                
                $('#qrCodeContainer').html(`<img src="${qrCodeUrl}" alt="QR Code PIX">`);
                $('#pixCode').text(pixCode);
                
                console.log('âœ… QR Code PIX gerado');
                
                // Iniciar verificaÃ§Ã£o de pagamento (simulado)
                iniciarVerificacaoPix();
                
            } catch(e) {
                console.error('âŒ Erro ao gerar PIX:', e);
                showToast('Erro ao gerar PIX: ' + e.message, 'error');
            }
        }

        function generateRandomUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function copiarPixCode() {
            const code = $('#pixCode').text();
            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                const textoOriginal = btn.textContent;
                btn.textContent = "âœ“ CÃ“DIGO COPIADO!";
                btn.style.background = "#39FF14";
                setTimeout(() => {
                    btn.textContent = textoOriginal;
                    btn.style.background = "";
                }, 2000);
            }).catch(() => {
                prompt("Copie o cÃ³digo PIX:", code);
            });
        }

        // Verificar pagamento PIX - consulta o banco para ver se foi pago
        function iniciarVerificacaoPix() {
            console.log('ğŸ”„ Aguardando confirmaÃ§Ã£o de pagamento PIX...');
            
            let segundos = 0;
            const tempoLimite = 600; // 10 minutos para pagar
            
            pixCheckInterval = setInterval(async () => {
                segundos++;
                
                const minutosRestantes = Math.floor((tempoLimite - segundos) / 60);
                const segsRestantes = (tempoLimite - segundos) % 60;
                $('#pixArea p:last').text(`â±ï¸ Aguardando pagamento... ${minutosRestantes}:${segsRestantes.toString().padStart(2, '0')}`);
                
                // A cada 5 segundos, verificar no banco se o pagamento foi registrado
                if (segundos % 5 === 0) {
                    console.log('ğŸ” Verificando status do pagamento no banco...');
                    
                    try {
                        if (tipoAgendamento === 'inscricao') {
                            // Verificar se participante jÃ¡ foi marcado como pago
                            const { data: participante } = await supabaseClient
                                .from('participantes_jogo')
                                .select('status_pagamento')
                                .eq('id', inscricaoId)
                                .single();
                            
                            if (participante && participante.status_pagamento === 'pago') {
                                clearInterval(pixCheckInterval);
                                console.log('âœ… Pagamento PIX confirmado via banco!');
                                showToast('Pagamento PIX confirmado!', 'success');
                                mostrarSucesso();
                                return;
                            }
                        } else {
                            // Verificar se agendamento/reserva mudou para confirmado
                            const tabela = tipoAgendamento === 'agendamento' ? 'agendamentos' : 'reservas';
                            const { data: registro } = await supabaseClient
                                .from(tabela)
                                .select('status')
                                .eq('id', agendamentoId)
                                .single();
                            
                            if (registro && (registro.status === 'confirmado' || registro.status === 'concluido')) {
                                clearInterval(pixCheckInterval);
                                console.log('âœ… Pagamento PIX confirmado via banco!');
                                
                                // Limpar localStorage
                                localStorage.removeItem('reserva_pendente_id');
                                localStorage.removeItem('reserva_pendente_quadra');
                                localStorage.removeItem('reserva_pendente_data');
                                localStorage.removeItem('reserva_pendente_hora');
                                localStorage.removeItem('agendamento_pendente_id');
                                localStorage.removeItem('agendamento_pendente_quadra');
                                localStorage.removeItem('agendamento_pendente_data');
                                localStorage.removeItem('agendamento_pendente_hora');
                                localStorage.removeItem('agendamento_pendente_valor');
                                localStorage.removeItem('agendamento_pendente_modo');
                                
                                showToast('Pagamento PIX confirmado!', 'success');
                                mostrarSucesso();
                                return;
                            }
                        }
                    } catch(e) {
                        console.error('Erro ao verificar pagamento:', e);
                    }
                }
                
                // Tempo expirou sem pagamento
                if (segundos >= tempoLimite) {
                    clearInterval(pixCheckInterval);
                    console.log('â° Tempo expirado! PIX nÃ£o foi pago.');
                    
                    $('#pixArea').html(`
                        <div class="pix-area">
                            <div style="font-size: 60px; margin-bottom: 15px;">â°</div>
                            <h2 style="color: #FF0040; margin-bottom: 15px;">TEMPO EXPIRADO</h2>
                            <p style="color: #888; margin-bottom: 20px;">O cÃ³digo PIX expirou. Nenhum pagamento foi detectado.</p>
                            <button class="btn" onclick="selectPaymentMethod('pix')" style="margin-bottom: 10px;">
                                ğŸ”„ GERAR NOVO CÃ“DIGO PIX
                            </button>
                            <button class="btn" onclick="selectPaymentMethod('card')" style="background: #333; color: white; box-shadow: none;">
                                ğŸ’³ PAGAR COM CARTÃƒO
                            </button>
                        </div>
                    `);
                    
                    showToast('CÃ³digo PIX expirado. Gere um novo ou pague com cartÃ£o.', 'error');
                }
            }, 1000);
        }
    </script>
</body>
</html>
